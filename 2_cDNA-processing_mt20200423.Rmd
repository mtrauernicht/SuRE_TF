---
title: "cDNA processing"
author: "Max Trauernicht"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: 
  html_document:
    theme: journal #cerulean
    highlight: monochrome
    toc: true
    toc_float: true
    code_folding: show
  editor_options:
    chunk_output_type: console
---

# knitr document van Steensel lab

# Introduction
I previously processed the raw sequencing data, optimized the barcode clustering, quantified the pDNA data and normalized the cDNA data. In this script, I want to have a detailed look at the cDNA data from a general perspective.

## Description of Data
How to make a good rendering table: 
```{r table1, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
| column1	|	column2	|	column3	|	
|----|----|----|
|1	|	2	|	3	|	
|a	|	b	|	c	|	
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

# Data processing
## Path, Libraries, Parameters and Useful Functions
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
library(RColorBrewer)
library(ggplot2)
library(dplyr)
library(maditr)
library(tibble)
library(pheatmap)
```

### Custom functions
Functions used thoughout this script.
```{r}
SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}

# From Fede:
# ggpairs custom functions
corColor <- function(data, mapping, color = I("black"), sizeRange = c(1, 3), ...) {

  x   <- eval_data_col(data, mapping$x)
  y   <- eval_data_col(data, mapping$y)
  r   <- cor(x, y)
  rt  <- format(r, digits = 3)
  tt  <- as.character(rt)
  cex <- max(sizeRange)

  # helper function to calculate a useable size
  percent_of_range <- function(percent, range) {
    percent * diff(range) + min(range, na.rm = TRUE)
  }

  # plot correlation coefficient
  p <- ggally_text(label = tt, mapping = aes(), xP = 0.5, yP = 0.5,
                   size = I(percent_of_range(cex * abs(r), sizeRange)), color = color, ...) +
    theme(panel.grid.minor=element_blank(),
          panel.grid.major=element_blank())

  corColors <- RColorBrewer::brewer.pal(n = 7, name = "RdYlBu")[2:6]

  if (r <= boundaries[1]) {
    corCol <- corColors[1]
  } else if (r <= boundaries[3]) {
    corCol <- corColors[2]
  } else if (r < boundaries[3]) {
    corCol <- corColors[3]
  } else if (r < boundaries[4]) {
    corCol <- corColors[4]
  } else {
    corCol <- corColors[5]
  }

  p <- p +
    theme(panel.background = element_rect(fill = corCol))

  return(p)
}
```


## Data import
```{r}
# Import processed bc counts from the preprocessing step
cDNA_df <- read.csv("/DATA/usr/m.trauernicht/projects/tf_activity_reporter/data/SuRE_TF_1/results/mt20200430_reporter_activity_filt.csv", header = T)
cDNA_df$background <- as.character(cDNA_df$background)
cDNA_df <- na.omit(cDNA_df)
```

# Analysis



## First insights into data distribution - reporter activity distribution plots
```{r data_density, out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE}
## reporter activity distribution over all experiments
colors <- c("#3D9F83", "#EFD279")

## reporter activity distribution for each experiment individually
ggplot(data = cDNA_df, aes(x = activity)) + 
  geom_density(fill = "#3D9F83") + xlab("normalized reporter activity: cDNA/pDNA") + 
  labs(title = "reporter activity distribution") +
  xlim(0,2) + theme_classic() + facet_wrap(vars(condition))

## reporter activity distribution for each experiment individually
ggplot(data = cDNA_df, aes(x = activity, color = condition)) + 
  stat_ecdf() + xlab("normalized reporter activity: cDNA/pDNA") + 
  labs(title = "reporter activity distribution") + ylab("fraction") +
  xlim(0,5) + theme_classic()


## reporter activity distribution - highlight negative motif controls
ggplot(cDNA_df[cDNA_df$hPGK == "No",], aes(x = activity, fill = neg_ctrls, alpha = 0.4)) + 
  geom_density() + xlab("normalized reporter activity: cDNA/pDNA") + 
  labs(title = "reporter activity distribution - negative ctrls") +
  scale_fill_manual(values = colors) +
  xlim(0,5) + theme_classic()


## reporter activity distribution - highlight positive hPGK control
ggplot(cDNA_df, aes(x = activity, fill = hPGK, alpha = 0.4)) + 
  geom_density() + xlab("normalized reporter activity: cDNA/pDNA") + 
  labs(title = "reporter activity distribution - hPGK") +
  scale_fill_manual(values = colors) +
  xlim(0,5) + theme_classic()

## reporter activity distribution - highlight Miguels enhancer control
ggplot(cDNA_df, aes(x = activity, fill = native_enhancer, alpha = 0.4)) + 
  geom_density() + xlab("normalized reporter activity: cDNA/pDNA") + 
  labs(title = "reporter activity distribution - native enhancers") +
  scale_fill_manual(values = colors) +
  xlim(0,5) + theme_classic()+ facet_wrap(vars(condition))

## reporter activity distribution - highlight Miguels enhancer control
ggplot(cDNA_df, aes(x = activity, fill = native_enhancer, alpha = 0.4)) + 
  geom_density() + xlab("normalized reporter activity: cDNA/pDNA") + 
  labs(title = "reporter activity distribution - native enhancers") +
  scale_fill_manual(values = colors) +
  xlim(10,20) + theme_classic()+ facet_wrap(vars(condition))


## reporter activity distribution - highlight different promoters
ggplot(cDNA_df, aes(x = activity, fill = promoter, alpha = 0.4)) + 
  geom_density() + xlab("normalized reporter activity: cDNA/pDNA") + 
  labs(title = "reporter activity distribution - promoters") +
  scale_fill_brewer("Dark2") +
  xlim(0,5) + theme_classic()

## reporter activity distribution - highlight random promoters
ggplot(cDNA_df, aes(x = activity, fill = rand_promoter, alpha = 0.4)) + 
  geom_density() + xlab("normalized reporter activity: cDNA/pDNA") + 
  labs(title = "reporter activity distribution - random promoter") +
  scale_fill_manual(values = colors) +
  xlim(0,5) + theme_classic()

## reporter activity distribution - highlight different distances
ggplot(cDNA_df[cDNA_df$distance != "",], 
       aes(x = activity, fill = distance, alpha = 0.4)) + 
  geom_density() + xlab("normalized reporter activity: cDNA/pDNA") + 
  labs(title = "reporter activity distribution - distances") +
  scale_fill_manual(values = colors) +
  xlim(0,5) + theme_classic()

## reporter activity distribution - highlight different spacings
ggplot(cDNA_df[cDNA_df$spacing != "",], aes(x = activity, fill = spacing, alpha = 0.4)) + 
  geom_density() + xlab("normalized reporter activity: cDNA/pDNA") + 
  labs(title = "reporter activity distribution - spacings") +
  scale_fill_manual(values = colors) +
  xlim(0,5) + theme_classic()

colors2 <- c("#3D9F83", "#EFD279", "#056B58")
## reporter activity distribution - highlight different backgrounds
ggplot(cDNA_df[cDNA_df$background != "0",], aes(x = activity, fill = background, alpha = 0.4)) + 
  geom_density() + xlab("normalized reporter activity: cDNA/pDNA") + 
  labs(title = "reporter activity distribution - backgrounds") +
  scale_fill_manual(values = colors2) +
  xlim(0,5) + theme_classic()
```




## Heat map - condition vs. TF
```{r}
## Prepare dataframe
# Caculate mean TF activity per condition
cDNA_df$tf_activity <- ave(cDNA_df$activity, cDNA_df$condition, cDNA_df$TF, FUN = function(x) mean(x))

tf_activity_heatmap <- cDNA_df[cDNA_df$neg_ctrls == "No" & cDNA_df$hPGK == "No" &
                               cDNA_df$native_enhancer == "No" & cDNA_df$rand_promoter == "No",] %>% 
  select(TF, condition, tf_activity) %>% unique()
tf_activity_heatmap <- dcast(tf_activity_heatmap, TF ~ condition, value.var="tf_activity")
tf_activity_heatmap <- tf_activity_heatmap %>% 
  remove_rownames %>% column_to_rownames(var="TF")
# Keeping the scale in the pheatmap function
myBreaks1 <- seq(0,5,0.05)

# pheatmap function: logratio heatmap of each individual drug vs. barcode - 10uM drugs added
pheatmap(as.matrix(tf_activity_heatmap),
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         breaks = myBreaks1)
```

# Results
```{r}
```

# Conclusions
```{r}
```

## Exporting potential data. 
```{r}
```

# Session Info
```{r}
paste("Run time: ",format(Sys.time()-StartTime))
getwd()
date()
sessionInfo()
```

