---
title: "EP-SuRE - exploratory analysis of combined iPCR and ECN data"
author: "FC"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    theme: journal #cerulean
    highlight: monochrome
    toc: true
    toc_float: true
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r knitr setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = TRUE, fig.align = 'center', fig.width = 5, fig.height = 5)
```

```{r libs and fun, include = FALSE}
library(tidyverse)
library(magrittr)
library(reshape2)
library(ggplot2)
library(here)
```
---

## Aims

Exploratory analysis of merged (complete cases) tables. For the first part, we largely draw from our previous characterization of the iPCR library. Note that we refer to 'complete quantification' to indicate iPCR+cDNA quantification/detection.

## Fragment representation and identity

```{r load tables, echo = FALSE}
load(here('../data/fc180207_epsure_tibs.RData'))
```

```{r quantify fragment representation}
# compute number of distinct fragments represented in basal library
# with and without accounting for orientation
tib.mg.int.basal %>%
  distinct(frag1, id) %>% 
  summarise(n.frag = n_distinct(frag1), n.frag.dir = n_distinct(id))

# same, for combinations in cooperativity library
tib.mg.int.coop %>%
  distinct(frag1, frag2, id) %>% 
  summarise(n.comb = n_distinct(frag1, frag2), n.comb.dir = n_distinct(id))
```

325/384 (84.6%) fragments have complete quantification in the basal library, spanning 612/784 (78%) possible orientations (612/650, 94% of all possible orientations given 325 fragments). When account for directionality, the cooperativity library consists of 97938 distinct quantified combinations.

```{r enhancer promoter representation}
# split by identity
# with and without accounting for orientation
tib.mg.int.basal %>%
  mutate(type = substr(frag1, 1, 5)) %>%
  distinct(frag1, strand1, type) %>%
  group_by(type) %>%
  summarise(n.frag = n_distinct(frag1), n.dir = n())
  
# compute number of barcodes associated to E and P - basal
( df.tmp <- tib.mg.int.basal %>%
    mutate(type = substr(frag1, 1, 5)) %>%
    group_by(type) %>%
    summarise(n.bc = n_distinct(barcode)) )

df.tmp %>%
  ggplot(aes(type, n.bc, fill = type)) +
    geom_col() +
    labs(x = 'Element type', y = '#distinct barcodes', title = 'Basal library', caption = 'Based on complete cases') +
    scale_fill_manual(values=c('orangered', 'navyblue')) +
    theme_bw()

# compute number of barcodes associated to E and P - cooperativity
( df.tmp <- tib.mg.int.coop %>%
    mutate(type = paste0(ifelse(substr(frag1, 1, 5) == 'prmtr', 'P', 'E'), ':', ifelse(substr(frag2, 1, 5) == 'prmtr', 'P', 'E'))) %>%
    distinct(frag1, strand1, frag2, strand2, type) %>%
    group_by(type) %>%
    summarise(n.frag = n_distinct(frag1, frag2), n.dir = n()) )
  
melt(df.tmp) %>%
  ggplot(aes(type, value, group = variable, fill = type)) + 
    facet_wrap(~variable, labeller = labeller(variable = c(n.frag = 'Identity', n.dir = 'Identity + Orientation'))) +
    geom_col() +
    xlab('Combination type') +
    ylab('#combinations') +
    scale_fill_manual(values=c('orangered', 'orange', 'skyblue3', 'navyblue')) +
    theme_bw()
```

## Barcode distributions

```{r count barcodes per fragment}
# aggregate data by fragment (directional)
( tib.mg.int.basal.aggr <- tib.mg.int.basal %>%
  group_by(id) %>%
  summarise(n.bc = n_distinct(barcode), 
            n.cdna.1 = sum(cdna.counts.1.1, cdna.counts.1.2), 
            n.cdna.2 = sum(cdna.counts.2.1, cdna.counts.2.2),
            n.pdna.1 = sum(pdna.counts.1.1, pdna.counts.1.2)) %>% 
  arrange(desc(n.bc)) )

( tib.mg.int.coop.aggr <- tib.mg.int.coop %>%
  group_by(id) %>%
  summarise(n.bc = n_distinct(barcode), 
            n.cdna.1 = sum(cdna.counts.1.1, cdna.counts.1.2), 
            n.cdna.2 = sum(cdna.counts.2.1, cdna.counts.2.2),
            n.pdna.1 = sum(pdna.counts.1.1, pdna.counts.1.2)) %>% 
  arrange(desc(n.bc)) )

tib.mg.int.basal.aggr %>%
  mutate(n.bc = log2(n.bc)) %>%
  ggplot(aes(n.bc)) +
    geom_histogram(binwidth = 1) +
    labs(x = '#Distinct barcodes (log2)', y = '#Fragments', title = 'Basal library', caption = 'Based on complete cases') +
    theme_bw()

tib.mg.int.coop.aggr %>%
  mutate(n.bc = log2(n.bc)) %>%
  ggplot(aes(n.bc)) +
    geom_histogram(binwidth = 1) +
    labs(x = '#Distinct barcodes (log2)', y = '#Fragments', title = 'Cooperativity library', caption = 'Based on complete cases') +
    theme_bw()
```

## Visualizing fragment combinations

### Binary representation of duplets

```{r coop lib - heatmap of duplets, fig.width = 10, fig.height = 9, echo = FALSE}
# binary representation of fragment combinations (not directional)
hits.bin <- tib.mg.int.coop %>%
  select(frag1, frag2) %>%
  distinct %>%
  mutate(present = 1)

# plot heatmap (binary)
hits.bin %>%
  ggplot(aes(x = frag1, y = frag2)) + 
    geom_raster(aes(fill = factor(present))) +
    scale_fill_manual(values = "black") +
    labs(x = 'Element 1', y = 'Element 2', fill = 'Present', caption = '(cooperativity library: no basal element)') +
    theme(axis.text.x = element_text(angle = 90, color =  c('black', rep('transparent', 9))), 
          axis.text.y = element_text(color =  c('black', rep('transparent', 9))))
```

### Binary representation of duplets (re-ordered by frequency)

```{r coop lib - ordered heatmap of duplets, fig.width = 10, fig.height = 9, echo = FALSE}
# cast ep matrix from tibble
mat <- acast(hits.bin, frag1 ~ frag2, value.var = 'present', fill = 0) %>% 
  as.matrix

# reorder row/cols based on frequency
row.order <- mat %>% 
  rowSums %>% 
  order
col.order <- mat %>%
  colSums %>%
  order

mat <- mat[row.order, col.order] 

# plot binary heatmap
df.tmp <- melt(mat)
colnames(df.tmp) <- c('frag1', 'frag2', 'present')

df.tmp %>%
ggplot(aes(x = frag1, y = frag2)) + 
    geom_raster(aes(fill = factor(present))) +
    scale_fill_manual(values = c('skyblue3', 'orange')) +
    labs(x = 'Element 1', y = 'Element 2', fill = 'Present', caption = '(cooperativity library: no basal element)') +
    theme(axis.text.x = element_text(angle = 90, color =  c('black', rep('transparent', 4))), 
          axis.text.y = element_text(color =  c('black', rep('transparent', 4))))
```

### Number of orientations of duplets

```{r coop lib - orientation heatmap of duplets, fig.width = 10, fig.height = 9, echo = FALSE}
# number of orientations and barcodes per combination
hits.or <- tib.mg.int.coop %>%
  group_by(frag1, frag2) %>%
  summarise(n.or = n_distinct(strand1, strand2), n.bc = n_distinct(barcode)) %>%
  mutate(n.bc = log10(n.bc))

# plot heatmap (orientations)
hits.or %>%
  ggplot(aes(x = frag1, y = frag2, fill = n.or)) + 
    geom_raster(aes(fill = n.or)) +
    scale_fill_gradient(low = "skyblue",high = "black") +
    labs(x = 'Element 1', y = 'Element 2', fill = '#orient', caption = '(cooperativity library: no basal element)') +
    theme(axis.text.x = element_text(angle = 90, color =  c('black', rep('transparent', 9))), 
          axis.text.y = element_text(color =  c('black', rep('transparent', 9))))
```


## Correlation between replicates

```{r pairs cor, echo = FALSE, fig.width = 10, fig.height = 10}
GGally::ggpairs(tib.mg.int.basal, column = 6:12, lower = list(continuous = 'smooth')) +
  labs(title = 'Basal library') +
  theme_bw()

GGally::ggpairs(tib.mg.int.coop, column = 6:12, lower = list(continuous = 'smooth')) +
  labs(title = 'Cooperativity library') +
  theme_bw()
```


## SessionInfo

```{r}
sessionInfo()
```
